<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Texas Molt'em - Live Spectator</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Roboto', system-ui, sans-serif;
      background: #0a0a12;
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }

    .table-view {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #0a0a12 0%, #12121f 100%);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0,0,0,0.5);
      border-bottom: 1px solid #2a2a3a;
    }

    .header h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.4rem;
      color: #ffd700;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      letter-spacing: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .hand-info { font-size: 0.85rem; color: #888; }

    .phase-badge {
      background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    /* Table Area */
    .table-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      padding: 20px;
    }

    .poker-table {
      width: 900px;
      height: 500px;
      background: linear-gradient(145deg, #1b5e20 0%, #2e7d32 50%, #1b5e20 100%);
      border-radius: 250px;
      border: 20px solid #5d4037;
      box-shadow: inset 0 0 80px rgba(0,0,0,0.6), 0 20px 60px rgba(0,0,0,0.6), 0 0 0 8px #3e2723;
      position: relative;
    }

    .poker-table::before {
      content: '';
      position: absolute;
      top: 20px; left: 20px; right: 20px; bottom: 20px;
      border: 3px solid rgba(255,255,255,0.08);
      border-radius: 230px;
    }

    /* Ace Clawdstein - Dealer in center */
    .dealer-ace {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -120%);
      text-align: center;
      z-index: 50;
    }

    .dealer-avatar {
      width: 80px;
      height: 80px;
      background: linear-gradient(145deg, #c62828 0%, #8e0000 100%);
      border-radius: 50%;
      border: 4px solid #ffd700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
      margin: 0 auto 8px;
    }

    .dealer-name {
      font-family: 'Oswald', sans-serif;
      font-size: 0.9rem;
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    /* Narrator bubble from Ace */
    .narrator-bubble {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -220%);
      background: rgba(0,0,0,0.9);
      color: #ffd700;
      padding: 12px 20px;
      border-radius: 15px;
      font-size: 1rem;
      font-family: 'Oswald', sans-serif;
      max-width: 300px;
      text-align: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      border: 2px solid #ffd700;
      transition: opacity 0.3s;
    }

    .narrator-bubble.show {
      opacity: 1;
      animation: narratorIn 0.4s ease;
    }

    .narrator-bubble::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid #ffd700;
    }

    @keyframes narratorIn {
      0% { transform: translate(-50%, -220%) scale(0.8); opacity: 0; }
      100% { transform: translate(-50%, -220%) scale(1); opacity: 1; }
    }

    /* Community Cards */
    .community-cards {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, 20px);
      display: flex;
      gap: 10px;
    }

    /* Pot Display */
    .pot-area {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, 100px);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .chip-stack {
      display: flex;
      gap: 3px;
    }

    .chip {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.4);
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .chip.red { background: linear-gradient(145deg, #e53935 0%, #b71c1c 100%); }
    .chip.blue { background: linear-gradient(145deg, #1e88e5 0%, #0d47a1 100%); }
    .chip.green { background: linear-gradient(145deg, #43a047 0%, #1b5e20 100%); }
    .chip.black { background: linear-gradient(145deg, #424242 0%, #212121 100%); }
    .chip.gold { background: linear-gradient(145deg, #ffd700 0%, #ff8c00 100%); }

    .pot-display {
      background: rgba(0,0,0,0.85);
      padding: 8px 25px;
      border-radius: 20px;
      font-weight: bold;
      color: #ffd700;
      font-size: 1.1rem;
      font-family: 'Oswald', sans-serif;
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    /* Player Seats - positioned around table */
    .player-seat {
      position: absolute;
      width: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
    }

    /* Seat positions - lobsters sit outside the table */
    .seat-0 { bottom: -100px; left: 50%; transform: translateX(-50%); }
    .seat-1 { bottom: 30px; left: -80px; }
    .seat-2 { top: 30px; left: -80px; }
    .seat-3 { top: -100px; left: 50%; transform: translateX(-50%); }
    .seat-4 { top: 30px; right: -80px; }
    .seat-5 { bottom: 30px; right: -80px; }

    /* Lobster Character */
    .lobster-character {
      position: relative;
      text-align: center;
    }

    .lobster-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      margin: 0 auto;
      border: 4px solid #444;
      transition: all 0.3s;
    }

    /* Different colored lobsters for each player */
    .lobster-avatar.color-0 { background: linear-gradient(145deg, #e53935 0%, #b71c1c 100%); }
    .lobster-avatar.color-1 { background: linear-gradient(145deg, #8e24aa 0%, #4a148c 100%); }
    .lobster-avatar.color-2 { background: linear-gradient(145deg, #1e88e5 0%, #0d47a1 100%); }
    .lobster-avatar.color-3 { background: linear-gradient(145deg, #43a047 0%, #1b5e20 100%); }
    .lobster-avatar.color-4 { background: linear-gradient(145deg, #ff8f00 0%, #e65100 100%); }
    .lobster-avatar.color-5 { background: linear-gradient(145deg, #00acc1 0%, #006064 100%); }

    .player-seat.active .lobster-avatar {
      border-color: #ffd700;
      box-shadow: 0 0 30px #ffd700, 0 0 60px rgba(255, 215, 0, 0.5);
      animation: thinking 1s infinite;
    }

    @keyframes thinking {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .player-seat.folded .lobster-avatar {
      filter: grayscale(70%);
      opacity: 0.5;
    }

    .player-seat.winner .lobster-avatar {
      border-color: #4caf50;
      box-shadow: 0 0 40px #4caf50;
    }

    .player-name-tag {
      font-family: 'Oswald', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 5px;
      color: #fff;
    }

    .player-stack-display {
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      color: #4caf50;
      margin-top: 2px;
    }

    .player-profit {
      font-size: 0.75rem;
      margin-top: 2px;
    }

    .player-profit.positive { color: #4caf50; }
    .player-profit.negative { color: #e53935; }

    /* Player's cards - ON THE TABLE near the player */
    .player-cards-on-table {
      position: absolute;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    /* Card positions relative to each seat - cards go ON the table */
    .seat-0 .player-cards-on-table { bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 10px; }
    .seat-1 .player-cards-on-table { right: -80px; top: 50%; transform: translateY(-50%); }
    .seat-2 .player-cards-on-table { right: -80px; top: 50%; transform: translateY(-50%); }
    .seat-3 .player-cards-on-table { top: 100%; left: 50%; transform: translateX(-50%); margin-top: 10px; }
    .seat-4 .player-cards-on-table { left: -80px; top: 50%; transform: translateY(-50%); }
    .seat-5 .player-cards-on-table { left: -80px; top: 50%; transform: translateY(-50%); }

    /* Speech/Action bubble above player */
    .player-bubble {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 80px;
      padding: 10px 18px;
      border-radius: 15px;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      text-align: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    .player-bubble::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
    }

    .player-bubble.show {
      opacity: 1;
      animation: bubblePop 0.3s ease;
    }

    @keyframes bubblePop {
      0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    /* Action bubble styles */
    .player-bubble.action-fold {
      background: #424242;
      color: #999;
      border: 2px solid #666;
    }
    .player-bubble.action-fold::after { border-top: 10px solid #666; }

    .player-bubble.action-check {
      background: #2e7d32;
      color: #fff;
      border: 2px solid #4caf50;
    }
    .player-bubble.action-check::after { border-top: 10px solid #4caf50; }

    .player-bubble.action-call {
      background: #1565c0;
      color: #fff;
      border: 2px solid #2196f3;
    }
    .player-bubble.action-call::after { border-top: 10px solid #2196f3; }

    .player-bubble.action-bet, .player-bubble.action-raise {
      background: #e65100;
      color: #fff;
      border: 2px solid #ff9800;
    }
    .player-bubble.action-bet::after, .player-bubble.action-raise::after { border-top: 10px solid #ff9800; }

    .player-bubble.action-all-in {
      background: linear-gradient(135deg, #c62828 0%, #8e0000 100%);
      color: #fff;
      border: 2px solid #f44336;
      font-size: 1.2rem;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    .player-bubble.action-all-in::after { border-top: 10px solid #f44336; }

    /* Chat bubble - different style */
    .player-bubble.chat {
      background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
      color: #fff;
      border: 2px solid #e94560;
      font-family: 'Roboto', sans-serif;
      font-weight: 400;
      font-size: 0.9rem;
      max-width: 180px;
      white-space: normal;
    }
    .player-bubble.chat::after { border-top: 10px solid #e94560; }

    /* Player bet chips on table */
    .player-bet-on-table {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 5;
    }

    .bet-chip-small {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.3);
    }

    .bet-amount-label {
      background: rgba(0,0,0,0.8);
      color: #ffd700;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-family: 'Oswald', sans-serif;
    }

    /* Bet positions - closer to center of table */
    .seat-0 .player-bet-on-table { bottom: 180px; left: 50%; transform: translateX(-50%); }
    .seat-1 .player-bet-on-table { bottom: 60px; left: 100px; }
    .seat-2 .player-bet-on-table { top: 60px; left: 100px; }
    .seat-3 .player-bet-on-table { top: 180px; left: 50%; transform: translateX(-50%); }
    .seat-4 .player-bet-on-table { top: 60px; right: 100px; }
    .seat-5 .player-bet-on-table { bottom: 60px; right: 100px; }

    /* Win probability bar */
    .win-prob-bar {
      width: 100%;
      height: 6px;
      background: rgba(0,0,0,0.4);
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }

    .win-prob-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, #e53935, #ff9800, #4caf50);
      transition: width 0.5s;
    }

    .win-prob-text {
      font-size: 0.7rem;
      color: #aaa;
      margin-top: 2px;
    }

    /* Card Styles */
    .card {
      width: 44px;
      height: 62px;
      background: white;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
      position: relative;
    }

    .card.red { color: #e53935; }
    .card.black { color: #212121; }

    .card.hidden {
      background: linear-gradient(145deg, #1565c0 0%, #0d47a1 100%);
    }

    .card.hidden::after {
      content: '';
      position: absolute;
      top: 5px; left: 5px; right: 5px; bottom: 5px;
      background: repeating-linear-gradient(45deg, #1565c0, #1565c0 5px, #0d47a1 5px, #0d47a1 10px);
      border-radius: 3px;
    }

    .card .rank { font-size: 1rem; line-height: 1; }
    .card .suit { font-size: 1.2rem; line-height: 1; }

    .community-cards .card {
      width: 56px;
      height: 78px;
    }
    .community-cards .card .rank { font-size: 1.3rem; }
    .community-cards .card .suit { font-size: 1.6rem; }

    /* Empty seat */
    .player-seat.empty .lobster-avatar {
      background: rgba(0,0,0,0.3);
      border: 2px dashed #333;
    }

    .player-seat.empty .player-name-tag { color: #444; }

    /* Winner overlay */
    .winner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      padding: 30px 60px;
      border-radius: 20px;
      text-align: center;
      z-index: 500;
      display: none;
      border: 3px solid #ffd700;
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.4);
    }

    .winner-overlay.show { display: block; animation: popIn 0.4s ease; }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .winner-overlay .winner-name {
      font-family: 'Oswald', sans-serif;
      font-size: 2rem;
      color: #ffd700;
    }

    .winner-overlay .hand-name {
      color: #4caf50;
      font-size: 1.2rem;
      margin-top: 8px;
    }

    .winner-overlay .win-amount {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      margin-top: 12px;
    }

    /* Controls at bottom */
    .controls-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 10px 20px;
      background: rgba(0,0,0,0.7);
      border-top: 1px solid #2a2a3a;
    }

    .speed-select {
      background: #1a1a2e;
      border: 1px solid #333;
      color: #fff;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .demo-btn {
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
      letter-spacing: 1px;
      transition: all 0.3s;
    }

    .demo-btn.primary {
      background: linear-gradient(145deg, #e94560 0%, #c73e54 100%);
    }

    .demo-btn.secondary {
      background: linear-gradient(145deg, #7c3aed 0%, #5b21b6 100%);
    }

    .demo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    }

    .demo-btn:disabled {
      background: #333;
      cursor: not-allowed;
      transform: none;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: #666;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f44336;
    }

    .status-dot.connected { background: #4caf50; }
  </style>
</head>
<body>
  <div class="table-view">
    <div class="header">
      <h1>TEXAS MOLT'EM</h1>
      <div class="header-right">
        <span class="hand-info">Hand #<span id="handNumber">0</span></span>
        <span class="phase-badge" id="phase">WAITING</span>
      </div>
    </div>

    <div class="table-area">
      <div class="poker-table">
        <!-- Ace Clawdstein - The Dealer -->
        <div class="dealer-ace">
          <div class="dealer-avatar">ðŸ¦ž</div>
          <div class="dealer-name">Ace Clawdstein</div>
        </div>

        <!-- Narrator bubble from Ace -->
        <div class="narrator-bubble" id="narratorBubble"></div>

        <!-- Community Cards -->
        <div class="community-cards" id="communityCards"></div>

        <!-- Pot -->
        <div class="pot-area">
          <div class="chip-stack" id="chipStack"></div>
          <div class="pot-display">POT: $<span id="potAmount">0</span></div>
        </div>

        <!-- Player Seats -->
        <div class="player-seat seat-0" id="seat-0"></div>
        <div class="player-seat seat-1" id="seat-1"></div>
        <div class="player-seat seat-2" id="seat-2"></div>
        <div class="player-seat seat-3" id="seat-3"></div>
        <div class="player-seat seat-4" id="seat-4"></div>
        <div class="player-seat seat-5" id="seat-5"></div>

        <!-- Winner Overlay -->
        <div class="winner-overlay" id="winnerOverlay">
          <div class="winner-name" id="winnerName"></div>
          <div class="hand-name" id="handName"></div>
          <div class="win-amount" id="winAmount"></div>
        </div>
      </div>
    </div>

    <div class="controls-bar">
      <select class="speed-select" id="speedSelect">
        <option value="very-slow" selected>Very Slow (TV Style)</option>
        <option value="slow">Slow</option>
        <option value="normal">Normal</option>
      </select>
      <button class="demo-btn primary" id="demoBtn" onclick="startDemo()">START DEMO</button>
      <button class="demo-btn secondary" id="llmDemoBtn" onclick="startLLMDemo()">AI DEMO</button>
      <div class="connection-status">
        <span class="status-dot" id="statusDot"></span>
        <span id="connectionText">Connecting...</span>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let gameState = {
      phase: 'waiting',
      handNumber: 0,
      buttonPosition: 0,
      activePosition: null,
      communityCards: [],
      seats: [null, null, null, null, null, null],
      pot: 0,
      initialStacks: {}
    };

    const AGENT_NAMES = {
      '0xDEMO000000000000000000000000000000000001': 'Crabby Carl',
      '0xDEMO000000000000000000000000000000000002': 'Shelly Steve',
      '0xDEMO000000000000000000000000000000000003': 'Pinchy Pete',
      '0xDEMO000000000000000000000000000000000004': 'Clawdia',
      '0xDEMO000000000000000000000000000000000005': 'Barnacle Bill',
      '0xDEMO000000000000000000000000000000000006': 'Sandy',
    };

    function formatAmount(amount) {
      const num = typeof amount === 'string' ? parseInt(amount) : Number(amount);
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
      return num.toLocaleString();
    }

    function getPlayerName(address) {
      return AGENT_NAMES[address] || address.slice(0, 6) + '...' + address.slice(-4);
    }

    function getSuitSymbol(suit) {
      return { h: 'â™¥', d: 'â™¦', c: 'â™£', s: 'â™ ' }[suit] || suit;
    }

    function isRedSuit(suit) {
      return suit === 'h' || suit === 'd';
    }

    // FIX: Convert T to 10 for display
    function displayRank(rank) {
      return rank === 'T' ? '10' : rank;
    }

    function renderCard(card, hidden = false) {
      if (!card || hidden) {
        return '<div class="card hidden"></div>';
      }
      const colorClass = isRedSuit(card.suit) ? 'red' : 'black';
      return `
        <div class="card ${colorClass}">
          <span class="rank">${displayRank(card.rank)}</span>
          <span class="suit">${getSuitSymbol(card.suit)}</span>
        </div>
      `;
    }

    function calculateWinProbability(seatIndex) {
      const seat = gameState.seats[seatIndex];
      if (!seat || seat.isFolded || !seat.holeCards || seat.holeCards.length === 0) return 0;

      const activePlayers = gameState.seats.filter(s => s && !s.isFolded).length;
      if (activePlayers === 0) return 0;

      let strength = 50 / activePlayers;
      const cards = seat.holeCards;

      if (cards.length >= 2) {
        const rank1 = '23456789TJQKA'.indexOf(cards[0].rank);
        const rank2 = '23456789TJQKA'.indexOf(cards[1].rank);
        strength += (rank1 + rank2) * 1.5;
        if (rank1 === rank2) strength += 15 + rank1 * 2;
        if (cards[0].suit === cards[1].suit) strength += 5;
        if (Math.abs(rank1 - rank2) === 1) strength += 4;
      }

      return Math.min(95, Math.max(5, Math.round(strength)));
    }

    function renderChipStack() {
      const pot = calculatePot();
      const potNum = Number(pot);
      const stack = document.getElementById('chipStack');

      if (potNum === 0) { stack.innerHTML = ''; return; }

      let chips = [];
      let rem = potNum;
      if (rem >= 10000) { chips.push('gold'); rem -= 10000; }
      if (rem >= 5000) { chips.push('black'); rem -= 5000; }
      if (rem >= 1000) { chips.push('green'); rem -= 1000; }
      if (rem >= 500) { chips.push('blue'); rem -= 500; }
      if (rem >= 100) { chips.push('red'); }
      if (chips.length === 0) chips.push('red');
      chips = chips.slice(0, 5);

      stack.innerHTML = chips.map(c => `<div class="chip ${c}"></div>`).join('');
    }

    function renderSeat(seatIndex) {
      const seat = gameState.seats[seatIndex];
      const el = document.getElementById(`seat-${seatIndex}`);

      if (!seat) {
        el.className = `player-seat seat-${seatIndex} empty`;
        el.innerHTML = `
          <div class="lobster-character">
            <div class="lobster-avatar color-${seatIndex}">ðŸ¦ž</div>
            <div class="player-name-tag">Empty Seat</div>
          </div>
        `;
        return;
      }

      const isActive = gameState.activePosition === seatIndex;
      const isFolded = seat.isFolded;
      const classes = ['player-seat', `seat-${seatIndex}`];
      if (isActive) classes.push('active');
      if (isFolded) classes.push('folded');
      el.className = classes.join(' ');

      // Calculate profit/loss
      const initialStack = gameState.initialStacks[seat.address] || seat.stack;
      const currentStack = BigInt(seat.stack);
      const profit = currentStack - BigInt(initialStack);
      const profitClass = profit >= 0n ? 'positive' : 'negative';
      const profitStr = profit >= 0n ? '+$' + formatAmount(profit.toString()) : '-$' + formatAmount((-profit).toString());

      // Win probability
      const winPct = calculateWinProbability(seatIndex);
      const showProb = seat.holeCards && seat.holeCards.length > 0 && !isFolded && gameState.phase !== 'waiting';

      // Cards on table
      const cards = seat.holeCards || [];
      const cardsHtml = cards.length > 0
        ? `<div class="player-cards-on-table">${cards.map(c => renderCard(c, isFolded)).join('')}</div>`
        : '';

      // Bet on table
      const currentBet = seat.currentBet ? BigInt(seat.currentBet) : 0n;
      let betHtml = '';
      if (currentBet > 0n) {
        const betNum = Number(currentBet);
        let chipColor = 'red';
        if (betNum >= 10000) chipColor = 'gold';
        else if (betNum >= 5000) chipColor = 'black';
        else if (betNum >= 1000) chipColor = 'green';
        else if (betNum >= 500) chipColor = 'blue';

        betHtml = `
          <div class="player-bet-on-table">
            <div class="bet-chip-small chip ${chipColor}"></div>
            <span class="bet-amount-label">$${formatAmount(currentBet.toString())}</span>
          </div>
        `;
      }

      el.innerHTML = `
        <div class="player-bubble" id="bubble-${seatIndex}"></div>
        <div class="lobster-character">
          <div class="lobster-avatar color-${seatIndex}">ðŸ¦ž</div>
          <div class="player-name-tag">${getPlayerName(seat.address)}</div>
          <div class="player-stack-display">$${formatAmount(seat.stack)}</div>
          <div class="player-profit ${profitClass}">${profitStr}</div>
          ${showProb ? `
            <div class="win-prob-bar"><div class="fill" style="width: ${winPct}%"></div></div>
            <div class="win-prob-text">${winPct}% equity</div>
          ` : ''}
        </div>
        ${cardsHtml}
        ${betHtml}
      `;
    }

    function renderCommunityCards() {
      const el = document.getElementById('communityCards');
      el.innerHTML = gameState.communityCards.map(c => renderCard(c)).join('');
    }

    function calculatePot() {
      let pot = BigInt(gameState.pot || 0);
      for (const seat of gameState.seats) {
        if (seat && seat.currentBet) pot += BigInt(seat.currentBet);
      }
      return pot;
    }

    function collectBetsToPot() {
      for (const seat of gameState.seats) {
        if (seat && seat.currentBet) {
          gameState.pot = (BigInt(gameState.pot || 0) + BigInt(seat.currentBet)).toString();
          seat.currentBet = '0';
        }
      }
    }

    // Show action bubble above specific player
    function showPlayerBubble(seatIndex, text, type, duration = 2500) {
      const bubble = document.getElementById(`bubble-${seatIndex}`);
      if (!bubble) return;

      bubble.textContent = text;
      bubble.className = `player-bubble ${type} show`;

      setTimeout(() => {
        bubble.classList.remove('show');
      }, duration);
    }

    // Ace narrates
    function aceNarrates(text, duration = 3000) {
      const bubble = document.getElementById('narratorBubble');
      bubble.textContent = text;
      bubble.classList.add('show');

      setTimeout(() => {
        bubble.classList.remove('show');
      }, duration);
    }

    function renderState() {
      document.getElementById('handNumber').textContent = gameState.handNumber;
      document.getElementById('phase').textContent = gameState.phase.toUpperCase();
      document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());

      for (let i = 0; i < 6; i++) renderSeat(i);
      renderCommunityCards();
      renderChipStack();
    }

    function showWinner(winners, handName, timeout = 4000) {
      const el = document.getElementById('winnerOverlay');
      if (winners && winners.length > 0) {
        const winner = winners[0];
        const seat = gameState.seats[winner.seatIndex];
        const name = seat ? getPlayerName(seat.address) : 'Winner';

        document.getElementById('winnerName').textContent = name + ' WINS!';
        document.getElementById('handName').textContent = handName || '';
        document.getElementById('winAmount').textContent = '$' + formatAmount(winner.amount);

        const seatEl = document.getElementById(`seat-${winner.seatIndex}`);
        if (seatEl) seatEl.classList.add('winner');

        el.classList.add('show');
        aceNarrates(`${name} takes the pot with ${handName}!`, 4000);

        setTimeout(() => {
          el.classList.remove('show');
          if (seatEl) seatEl.classList.remove('winner');
        }, timeout);
      }
    }

    // WebSocket
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}?role=spectator`);

      ws.onopen = () => {
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('connectionText').textContent = 'Connected';
        aceNarrates("Welcome to ClawdVegas! I'm Ace, your dealer tonight.", 4000);
      };

      ws.onclose = () => {
        document.getElementById('statusDot').classList.remove('connected');
        document.getElementById('connectionText').textContent = 'Disconnected';
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        document.getElementById('connectionText').textContent = 'Error';
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleEvent(msg.event, msg.data);
        } catch (e) {
          console.error('Parse error:', e);
        }
      };
    }

    function handleEvent(event, data) {
      console.log('Event:', event, data);

      switch (event) {
        case 'connected':
          if (data) {
            gameState = {
              ...gameState,
              phase: data.phase || 'waiting',
              handNumber: data.handNumber || 0,
              buttonPosition: data.buttonPosition || 0,
              activePosition: data.activePosition,
              communityCards: data.communityCards || [],
              seats: data.seats || [null, null, null, null, null, null],
              pot: 0
            };
            renderState();
          }
          break;

        case 'player_sat':
          gameState.seats[data.seatIndex] = {
            address: data.address,
            stack: data.stack,
            currentBet: '0',
            holeCards: null,
            isFolded: false,
            isAllIn: false
          };
          gameState.initialStacks[data.address] = data.stack;
          aceNarrates(`${getPlayerName(data.address)} joins the table!`, 2500);
          renderState();
          break;

        case 'player_stood':
          gameState.seats[data.seatIndex] = null;
          renderState();
          break;

        case 'hand_started':
          gameState.handNumber = data.handNumber;
          gameState.buttonPosition = data.button;
          gameState.phase = 'preflop';
          gameState.communityCards = [];
          gameState.pot = 0;
          for (const seat of gameState.seats) {
            if (seat) {
              seat.currentBet = '0';
              seat.holeCards = null;
              seat.isFolded = false;
              seat.isAllIn = false;
            }
          }
          aceNarrates(`Hand #${data.handNumber} - Let's see some action!`, 3000);
          renderState();
          break;

        case 'hole_cards_dealt':
          if (gameState.seats[data.seatIndex]) {
            gameState.seats[data.seatIndex].holeCards = data.cards;
            renderSeat(data.seatIndex);
          }
          break;

        case 'blinds_posted':
          if (data.smallBlind && gameState.seats[data.smallBlind.seat]) {
            gameState.seats[data.smallBlind.seat].currentBet = data.smallBlind.amount;
          }
          if (data.bigBlind && gameState.seats[data.bigBlind.seat]) {
            gameState.seats[data.bigBlind.seat].currentBet = data.bigBlind.amount;
          }
          aceNarrates(`Blinds are $${formatAmount(data.smallBlind.amount)} / $${formatAmount(data.bigBlind.amount)}`, 2500);
          renderState();
          break;

        case 'action_on':
          gameState.activePosition = data.seatIndex;
          renderState();
          break;

        case 'player_acted':
          const playerName = getPlayerName(data.address);
          const seatIdx = data.seatIndex;
          let actionText = data.action.toUpperCase();
          let bubbleType = 'action-' + data.action.toLowerCase().replace('_', '-');

          if (data.amount && data.amount !== '0' && !['fold', 'check'].includes(data.action)) {
            actionText += ' $' + formatAmount(data.amount);
          }

          // Show bubble above the player who acted
          showPlayerBubble(seatIdx, actionText, bubbleType, 2500);

          if (gameState.seats[seatIdx]) {
            gameState.seats[seatIdx].stack = data.newStack;
            if (data.action === 'fold') {
              gameState.seats[seatIdx].isFolded = true;
              gameState.seats[seatIdx].currentBet = '0';
            } else if (['bet', 'raise', 'call'].includes(data.action)) {
              if (data.totalBet) gameState.seats[seatIdx].currentBet = data.totalBet;
            }
            if (data.action === 'all_in' || data.action === 'all-in') {
              gameState.seats[seatIdx].isAllIn = true;
            }
          }
          gameState.activePosition = null;
          renderState();
          break;

        case 'flop_dealt':
          gameState.phase = 'flop';
          gameState.communityCards = data.cards;
          collectBetsToPot();
          aceNarrates(`The flop: ${data.cards.map(c => displayRank(c.rank) + getSuitSymbol(c.suit)).join(' ')}`, 3000);
          renderState();
          break;

        case 'turn_dealt':
          gameState.phase = 'turn';
          gameState.communityCards.push(data.card);
          collectBetsToPot();
          aceNarrates(`The turn: ${displayRank(data.card.rank)}${getSuitSymbol(data.card.suit)}`, 2500);
          renderState();
          break;

        case 'river_dealt':
          gameState.phase = 'river';
          gameState.communityCards.push(data.card);
          collectBetsToPot();
          aceNarrates(`The river: ${displayRank(data.card.rank)}${getSuitSymbol(data.card.suit)}`, 2500);
          renderState();
          break;

        case 'showdown':
          gameState.phase = 'showdown';
          for (const hand of data.hands || []) {
            if (gameState.seats[hand.seatIndex]) {
              gameState.seats[hand.seatIndex].holeCards = hand.cards;
            }
          }
          aceNarrates("Showdown! Let's see those cards!", 3000);
          renderState();
          break;

        case 'pot_awarded':
          collectBetsToPot();
          let winHandName = '';
          for (const winner of data.winners || []) {
            winHandName = winner.handName || '';
          }
          showWinner(data.winners, winHandName);
          break;

        case 'hand_complete':
          gameState.phase = 'waiting';
          gameState.activePosition = null;
          gameState.pot = 0;
          renderState();
          break;

        case 'phase_changed':
          gameState.phase = data.phase;
          renderState();
          break;

        case 'chat':
          const chatSeatIndex = gameState.seats.findIndex(s => s && s.address === data.address);
          if (chatSeatIndex !== -1) {
            showPlayerBubble(chatSeatIndex, data.message, 'chat', 4000);
          }
          break;
      }
    }

    async function startDemo() {
      const btn = document.getElementById('demoBtn');
      const speed = document.getElementById('speedSelect').value;
      btn.disabled = true;
      btn.textContent = 'STARTING...';

      try {
        const response = await fetch('/api/operator/demo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numAgents: 4, hands: 3, speed })
        });
        if (!response.ok) throw new Error('Failed');
        aceNarrates("Alright lobsters, let's play some poker!", 3000);
      } catch (e) {
        aceNarrates("Oops, something went wrong...", 3000);
      } finally {
        btn.disabled = false;
        btn.textContent = 'START DEMO';
      }
    }

    async function startLLMDemo() {
      const btn = document.getElementById('llmDemoBtn');
      btn.disabled = true;
      btn.textContent = 'AI THINKING...';
      aceNarrates("Claude agents are thinking... This might take a moment.", 4000);

      try {
        const response = await fetch('/api/operator/demo-llm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numAgents: 4, hands: 2 })
        });
        if (!response.ok) throw new Error('Failed');
      } catch (e) {
        aceNarrates("AI demo failed. Try again!", 3000);
      } finally {
        btn.disabled = false;
        btn.textContent = 'AI DEMO';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderState();
      connectWebSocket();
    });
  </script>
</body>
</html>
