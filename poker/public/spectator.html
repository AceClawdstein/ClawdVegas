<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Texas Molt'em - Live Spectator</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Roboto', system-ui, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }

    .table-view {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 20px;
      background: rgba(0,0,0,0.6);
      border-bottom: 1px solid #333;
    }

    .header h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      color: #ffd700;
      letter-spacing: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .hand-info { font-size: 0.8rem; color: #888; }

    .phase-badge {
      background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    /* Table Area */
    .table-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      padding: 10px;
    }

    .poker-table {
      width: 850px;
      height: 450px;
      background: linear-gradient(145deg, #0d5016 0%, #1a7a28 50%, #0d5016 100%);
      border-radius: 225px;
      border: 18px solid #5d4037;
      box-shadow: inset 0 0 60px rgba(0,0,0,0.5), 0 15px 50px rgba(0,0,0,0.5), 0 0 0 6px #3e2723;
      position: relative;
    }

    /* Table felt pattern */
    .poker-table::before {
      content: '';
      position: absolute;
      top: 15px; left: 15px; right: 15px; bottom: 15px;
      border: 2px solid rgba(255,255,255,0.06);
      border-radius: 210px;
    }

    /* ClawdVegas branding - subtle on felt */
    .table-branding {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
      opacity: 0.15;
    }

    .table-branding .brand-name {
      font-family: 'Oswald', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffd700;
      letter-spacing: 12px;
    }

    /* Total Pot Display - GGPoker style centered pill */
    .pot-display-container {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
    }

    .pot-pill {
      background: linear-gradient(180deg, rgba(0,60,0,0.9) 0%, rgba(0,40,0,0.95) 100%);
      border: 2px solid #2a5a2a;
      border-radius: 20px;
      padding: 6px 20px;
      text-align: center;
    }

    .pot-label {
      font-size: 0.7rem;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pot-amount {
      font-family: 'Oswald', sans-serif;
      font-size: 1.1rem;
      color: #ffd700;
      font-weight: 700;
    }

    /* Chip stack in center */
    .center-chips {
      position: absolute;
      top: 48%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 2px;
    }

    .chip {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.3);
    }

    .chip.red { background: linear-gradient(145deg, #e53935, #b71c1c); }
    .chip.blue { background: linear-gradient(145deg, #1e88e5, #0d47a1); }
    .chip.green { background: linear-gradient(145deg, #43a047, #1b5e20); }
    .chip.black { background: linear-gradient(145deg, #424242, #212121); }
    .chip.gold { background: linear-gradient(145deg, #ffd700, #ff8c00); }

    /* Community Cards */
    .community-cards {
      position: absolute;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      gap: 8px;
    }

    /* Player Seats */
    .player-seat {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
    }

    /* 6 seat positions around oval table */
    .seat-0 { bottom: -75px; left: 50%; transform: translateX(-50%); }
    .seat-1 { top: 50%; left: -70px; transform: translateY(-50%); }
    .seat-2 { top: -75px; left: 28%; transform: translateX(-50%); }
    .seat-3 { top: -75px; right: 28%; transform: translateX(50%); }
    .seat-4 { top: 50%; right: -70px; transform: translateY(-50%); }
    .seat-5 { bottom: -75px; right: 30%; transform: translateX(50%); }

    /* Player card container */
    .player-card-area {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Player info box - like GGPoker */
    .player-info-box {
      background: linear-gradient(180deg, #2a2a3a 0%, #1a1a2a 100%);
      border-radius: 8px;
      padding: 4px 8px;
      text-align: center;
      min-width: 90px;
      border: 2px solid #333;
      position: relative;
    }

    .player-seat.active .player-info-box {
      border-color: #ffd700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .player-seat.folded .player-info-box {
      opacity: 0.5;
    }

    .player-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin: 0 auto 4px;
      border: 3px solid #444;
    }

    .player-avatar.color-0 { background: linear-gradient(145deg, #e53935, #b71c1c); }
    .player-avatar.color-1 { background: linear-gradient(145deg, #8e24aa, #4a148c); }
    .player-avatar.color-2 { background: linear-gradient(145deg, #1e88e5, #0d47a1); }
    .player-avatar.color-3 { background: linear-gradient(145deg, #43a047, #1b5e20); }
    .player-avatar.color-4 { background: linear-gradient(145deg, #ff8f00, #e65100); }
    .player-avatar.color-5 { background: linear-gradient(145deg, #00acc1, #006064); }

    .player-seat.active .player-avatar {
      border-color: #ffd700;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.5); }
      50% { box-shadow: 0 0 0 8px rgba(255, 215, 0, 0); }
    }

    .player-name {
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
    }

    .player-stack {
      font-family: 'Oswald', sans-serif;
      font-size: 0.85rem;
      color: #4caf50;
    }

    /* Action badge - inline with player like GGPoker */
    .action-badge {
      position: absolute;
      top: -8px;
      right: -10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      z-index: 50;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.2s ease;
    }

    .action-badge.show {
      opacity: 1;
      transform: scale(1);
    }

    .action-badge.fold { background: #666; color: #ccc; }
    .action-badge.check { background: #2e7d32; color: #fff; }
    .action-badge.call { background: #1565c0; color: #fff; }
    .action-badge.bet, .action-badge.raise { background: #e65100; color: #fff; }
    .action-badge.all-in { background: #c62828; color: #fff; }

    /* Player cards - in front of player */
    .player-cards {
      display: flex;
      gap: 3px;
      margin-bottom: 5px;
    }

    /* Card positions per seat */
    .seat-0 .player-cards { margin-bottom: 8px; }
    .seat-1 .player-cards { position: absolute; right: -70px; top: 50%; transform: translateY(-50%); }
    .seat-2 .player-cards { margin-top: 8px; order: 1; }
    .seat-3 .player-cards { margin-top: 8px; order: 1; }
    .seat-4 .player-cards { position: absolute; left: -70px; top: 50%; transform: translateY(-50%); }
    .seat-5 .player-cards { margin-bottom: 8px; }

    /* Reorder for top seats */
    .seat-2 .player-card-area, .seat-3 .player-card-area {
      flex-direction: column-reverse;
    }

    /* Dealer button */
    .dealer-btn {
      position: absolute;
      width: 22px;
      height: 22px;
      background: linear-gradient(145deg, #fff, #ddd);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: 900;
      color: #000;
      border: 2px solid #ffd700;
      z-index: 30;
    }

    .seat-0 .dealer-btn { top: -30px; right: 20px; }
    .seat-1 .dealer-btn { top: -5px; right: -25px; }
    .seat-2 .dealer-btn { bottom: -30px; right: 20px; }
    .seat-3 .dealer-btn { bottom: -30px; left: 20px; }
    .seat-4 .dealer-btn { top: -5px; left: -25px; }
    .seat-5 .dealer-btn { top: -30px; left: 20px; }

    /* Bet amount on table */
    .player-bet {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 4px;
      z-index: 10;
    }

    .bet-chips {
      display: flex;
      gap: 1px;
    }

    .bet-chips .chip { width: 14px; height: 14px; }

    .bet-amount {
      background: rgba(0,0,0,0.7);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      color: #fff;
    }

    /* Bet positions toward center */
    .seat-0 .player-bet { top: -50px; left: 50%; transform: translateX(-50%); }
    .seat-1 .player-bet { top: 50%; left: 90px; transform: translateY(-50%); }
    .seat-2 .player-bet { bottom: -50px; left: 50%; transform: translateX(-50%); }
    .seat-3 .player-bet { bottom: -50px; left: 50%; transform: translateX(-50%); }
    .seat-4 .player-bet { top: 50%; right: 90px; transform: translateY(-50%); }
    .seat-5 .player-bet { top: -50px; left: 50%; transform: translateX(-50%); }

    /* Card Styles */
    .card {
      width: 38px;
      height: 54px;
      background: #fff;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .card.dealing {
      animation: dealCard 0.4s ease-out forwards;
    }

    @keyframes dealCard {
      0% { transform: translateY(-100px) rotate(-20deg); opacity: 0; }
      100% { transform: translateY(0) rotate(0); opacity: 1; }
    }

    .card .rank { font-size: 0.9rem; line-height: 1; }
    .card .suit { font-size: 1rem; line-height: 1; }

    .card.red { color: #e53935; }
    .card.black { color: #212121; }

    .card.folded { opacity: 0.4; filter: grayscale(0.5); }

    .card.hidden {
      background: linear-gradient(145deg, #c62828, #8e0000);
    }
    .card.hidden::after {
      content: '';
      position: absolute;
      inset: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 2px;
    }

    /* Community cards larger */
    .community-cards .card {
      width: 50px;
      height: 70px;
    }
    .community-cards .card .rank { font-size: 1.2rem; }
    .community-cards .card .suit { font-size: 1.4rem; }

    .community-cards .card.dealing {
      animation: dealCommunity 0.3s ease-out forwards;
    }

    @keyframes dealCommunity {
      0% { transform: translateY(50px) scale(0.5); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* Stagger community cards */
    .community-cards .card:nth-child(1) { animation-delay: 0s; }
    .community-cards .card:nth-child(2) { animation-delay: 0.1s; }
    .community-cards .card:nth-child(3) { animation-delay: 0.2s; }
    .community-cards .card:nth-child(4) { animation-delay: 0.3s; }
    .community-cards .card:nth-child(5) { animation-delay: 0.4s; }

    /* Winner overlay */
    .winner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      padding: 25px 50px;
      border-radius: 15px;
      text-align: center;
      z-index: 500;
      display: none;
      border: 3px solid #ffd700;
    }

    .winner-overlay.show { display: block; animation: popIn 0.3s ease; }

    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .winner-name { font-family: 'Oswald', sans-serif; font-size: 1.5rem; color: #ffd700; }
    .hand-name { color: #4caf50; font-size: 1rem; margin-top: 5px; }
    .win-amount { font-family: 'Oswald', sans-serif; font-size: 1.2rem; margin-top: 8px; }

    /* Controls */
    .controls-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 8px 20px;
      background: rgba(0,0,0,0.7);
    }

    .speed-select {
      background: #1a1a2e;
      border: 1px solid #333;
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
    }

    .demo-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      font-size: 0.8rem;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
    }

    .demo-btn.primary { background: linear-gradient(145deg, #e94560, #c73e54); }
    .demo-btn.secondary { background: linear-gradient(145deg, #7c3aed, #5b21b6); }
    .demo-btn:hover { transform: translateY(-1px); }
    .demo-btn:disabled { background: #333; cursor: not-allowed; transform: none; }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.7rem;
      color: #666;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #f44336;
    }
    .status-dot.connected { background: #4caf50; }

    /* Empty seat */
    .player-seat.empty .player-info-box { opacity: 0.3; }
    .player-seat.empty .player-avatar { background: #333; border-style: dashed; }

    /* Chat bubble */
    .chat-bubble {
      position: absolute;
      top: -45px;
      left: 50%;
      transform: translateX(-50%);
      background: #e94560;
      color: #fff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      z-index: 100;
    }

    .chat-bubble.show {
      opacity: 1;
      animation: chatPop 0.2s ease;
    }

    .chat-bubble::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #e94560;
    }

    @keyframes chatPop {
      0% { transform: translateX(-50%) scale(0.8); }
      100% { transform: translateX(-50%) scale(1); }
    }
  </style>
</head>
<body>
  <div class="table-view">
    <div class="header">
      <h1>TEXAS MOLT'EM - CLAWDVEGAS</h1>
      <div class="header-right">
        <span class="hand-info">Hand #<span id="handNumber">0</span></span>
        <span class="phase-badge" id="phase">WAITING</span>
      </div>
    </div>

    <div class="table-area">
      <div class="poker-table">
        <div class="table-branding">
          <div class="brand-name">CLAWDVEGAS</div>
        </div>

        <!-- Total Pot Display -->
        <div class="pot-display-container">
          <div class="pot-pill">
            <div class="pot-amount">Total Pot: $<span id="potAmount">0</span></div>
          </div>
        </div>

        <!-- Center chips -->
        <div class="center-chips" id="centerChips"></div>

        <!-- Community Cards -->
        <div class="community-cards" id="communityCards"></div>

        <!-- Player Seats -->
        <div class="player-seat seat-0" id="seat-0"></div>
        <div class="player-seat seat-1" id="seat-1"></div>
        <div class="player-seat seat-2" id="seat-2"></div>
        <div class="player-seat seat-3" id="seat-3"></div>
        <div class="player-seat seat-4" id="seat-4"></div>
        <div class="player-seat seat-5" id="seat-5"></div>

        <!-- Winner Overlay -->
        <div class="winner-overlay" id="winnerOverlay">
          <div class="winner-name" id="winnerName"></div>
          <div class="hand-name" id="handName"></div>
          <div class="win-amount" id="winAmount"></div>
        </div>
      </div>
    </div>

    <div class="controls-bar">
      <select class="speed-select" id="speedSelect">
        <option value="very-slow" selected>TV Style (Slow)</option>
        <option value="slow">Slow</option>
        <option value="normal">Normal</option>
      </select>
      <button class="demo-btn primary" id="demoBtn" onclick="startDemo()">START DEMO</button>
      <button class="demo-btn secondary" id="llmDemoBtn" onclick="startLLMDemo()">AI DEMO</button>
      <div class="connection-status">
        <span class="status-dot" id="statusDot"></span>
        <span id="connectionText">Connecting...</span>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // EVENT QUEUE - Process events sequentially
    // ==========================================
    const eventQueue = [];
    let processingQueue = false;

    function queueEvent(handler, delay = 0) {
      eventQueue.push({ handler, delay });
      if (!processingQueue) processQueue();
    }

    async function processQueue() {
      if (processingQueue || eventQueue.length === 0) return;
      processingQueue = true;

      while (eventQueue.length > 0) {
        const { handler, delay } = eventQueue.shift();
        await handler();
        if (delay > 0) await sleep(delay);
      }

      processingQueue = false;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ==========================================
    // GAME STATE
    // ==========================================
    let ws = null;
    let gameState = {
      phase: 'waiting',
      handNumber: 0,
      buttonPosition: 0,
      activePosition: null,
      communityCards: [],
      seats: [null, null, null, null, null, null],
      pot: 0,
      initialStacks: {}
    };

    const AGENT_NAMES = {
      '0xDEMO000000000000000000000000000000000001': 'Crabby Carl',
      '0xDEMO000000000000000000000000000000000002': 'Shelly Steve',
      '0xDEMO000000000000000000000000000000000003': 'Pinchy Pete',
      '0xDEMO000000000000000000000000000000000004': 'Clawdia',
      '0xDEMO000000000000000000000000000000000005': 'Barnacle Bill',
      '0xDEMO000000000000000000000000000000000006': 'Sandy',
    };

    // ==========================================
    // UTILITY FUNCTIONS
    // ==========================================
    function formatAmount(amount) {
      const num = typeof amount === 'string' ? parseInt(amount) : Number(amount);
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
      return num.toLocaleString();
    }

    function getPlayerName(address) {
      return AGENT_NAMES[address] || address.slice(0, 6) + '...' + address.slice(-4);
    }

    function getSuitSymbol(suit) {
      return { h: 'â™¥', d: 'â™¦', c: 'â™£', s: 'â™ ' }[suit] || suit;
    }

    function isRedSuit(suit) {
      return suit === 'h' || suit === 'd';
    }

    function displayRank(rank) {
      return rank === 'T' ? '10' : rank;
    }

    // ==========================================
    // RENDERING
    // ==========================================
    function renderCard(card, options = {}) {
      const { hidden = false, animate = false, folded = false } = options;
      if (!card || hidden) {
        return `<div class="card hidden${animate ? ' dealing' : ''}"></div>`;
      }
      const colorClass = isRedSuit(card.suit) ? 'red' : 'black';
      const classes = ['card', colorClass];
      if (animate) classes.push('dealing');
      if (folded) classes.push('folded');
      return `
        <div class="${classes.join(' ')}">
          <span class="rank">${displayRank(card.rank)}</span>
          <span class="suit">${getSuitSymbol(card.suit)}</span>
        </div>
      `;
    }

    function renderSeat(seatIndex, options = {}) {
      const { animateCards = false } = options;
      const seat = gameState.seats[seatIndex];
      const el = document.getElementById(`seat-${seatIndex}`);

      if (!seat) {
        el.className = `player-seat seat-${seatIndex} empty`;
        el.innerHTML = `
          <div class="player-card-area">
            <div class="player-info-box">
              <div class="player-avatar color-${seatIndex}">ðŸ¦ž</div>
              <div class="player-name">Empty</div>
            </div>
          </div>
        `;
        return;
      }

      const isActive = gameState.activePosition === seatIndex;
      const isFolded = seat.isFolded;
      const classes = ['player-seat', `seat-${seatIndex}`];
      if (isActive) classes.push('active');
      if (isFolded) classes.push('folded');
      el.className = classes.join(' ');

      // Cards
      const cards = seat.holeCards || [];
      const cardsHtml = cards.length > 0
        ? `<div class="player-cards">${cards.map(c => renderCard(c, { animate: animateCards, folded: isFolded })).join('')}</div>`
        : '';

      // Dealer button
      const isDealer = gameState.buttonPosition === seatIndex;
      const dealerHtml = isDealer ? '<div class="dealer-btn">D</div>' : '';

      // Bet on table
      const currentBet = seat.currentBet ? BigInt(seat.currentBet) : 0n;
      let betHtml = '';
      if (currentBet > 0n) {
        const betNum = Number(currentBet);
        let chipColor = 'red';
        if (betNum >= 10000) chipColor = 'gold';
        else if (betNum >= 5000) chipColor = 'black';
        else if (betNum >= 1000) chipColor = 'green';
        else if (betNum >= 500) chipColor = 'blue';

        betHtml = `
          <div class="player-bet">
            <div class="bet-chips"><div class="chip ${chipColor}"></div></div>
            <span class="bet-amount">$${formatAmount(currentBet.toString())}</span>
          </div>
        `;
      }

      // Action badge (will be shown/hidden via JS)
      const actionBadgeHtml = `<div class="action-badge" id="action-${seatIndex}"></div>`;

      // Chat bubble
      const chatBubbleHtml = `<div class="chat-bubble" id="chat-${seatIndex}"></div>`;

      el.innerHTML = `
        ${chatBubbleHtml}
        <div class="player-card-area">
          ${cardsHtml}
          <div class="player-info-box">
            ${actionBadgeHtml}
            <div class="player-avatar color-${seatIndex}">ðŸ¦ž</div>
            <div class="player-name">${getPlayerName(seat.address)}</div>
            <div class="player-stack">$${formatAmount(seat.stack)}</div>
          </div>
          ${dealerHtml}
        </div>
        ${betHtml}
      `;
    }

    function renderCommunityCards(animate = false) {
      const el = document.getElementById('communityCards');
      el.innerHTML = gameState.communityCards.map(c => renderCard(c, { animate })).join('');
    }

    function calculatePot() {
      let pot = BigInt(gameState.pot || 0);
      for (const seat of gameState.seats) {
        if (seat && seat.currentBet) pot += BigInt(seat.currentBet);
      }
      return pot;
    }

    function renderCenterChips() {
      const pot = calculatePot();
      const potNum = Number(pot);
      const el = document.getElementById('centerChips');

      if (potNum === 0) { el.innerHTML = ''; return; }

      let chips = [];
      if (potNum >= 10000) chips.push('gold');
      if (potNum >= 5000) chips.push('black');
      if (potNum >= 1000) chips.push('green');
      if (potNum >= 500) chips.push('blue');
      if (potNum >= 100 || chips.length === 0) chips.push('red');
      chips = chips.slice(0, 4);

      el.innerHTML = chips.map(c => `<div class="chip ${c}"></div>`).join('');
    }

    function renderState() {
      document.getElementById('handNumber').textContent = gameState.handNumber;
      document.getElementById('phase').textContent = gameState.phase.toUpperCase();
      document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());

      for (let i = 0; i < 6; i++) renderSeat(i);
      renderCommunityCards();
      renderCenterChips();
    }

    function collectBetsToPot() {
      for (const seat of gameState.seats) {
        if (seat && seat.currentBet) {
          gameState.pot = (BigInt(gameState.pot || 0) + BigInt(seat.currentBet)).toString();
          seat.currentBet = '0';
        }
      }
    }

    // ==========================================
    // ACTION DISPLAY
    // ==========================================
    function showActionBadge(seatIndex, action, duration = 2000) {
      const badge = document.getElementById(`action-${seatIndex}`);
      if (!badge) return;

      const actionLower = action.toLowerCase().replace('_', '-').replace(' ', '-');
      let displayText = action.toUpperCase();
      let badgeClass = actionLower.split(' ')[0]; // Get first word for class

      badge.textContent = displayText;
      badge.className = `action-badge ${badgeClass} show`;

      setTimeout(() => {
        badge.classList.remove('show');
      }, duration);
    }

    function showChatBubble(seatIndex, message, duration = 3000) {
      const bubble = document.getElementById(`chat-${seatIndex}`);
      if (!bubble) return;

      bubble.textContent = message;
      bubble.classList.add('show');

      setTimeout(() => {
        bubble.classList.remove('show');
      }, duration);
    }

    function showWinner(winners, handName, timeout = 4000) {
      const el = document.getElementById('winnerOverlay');
      if (winners && winners.length > 0) {
        const winner = winners[0];
        const seat = gameState.seats[winner.seatIndex];
        const name = seat ? getPlayerName(seat.address) : 'Winner';

        document.getElementById('winnerName').textContent = name + ' WINS!';
        document.getElementById('handName').textContent = handName || '';
        document.getElementById('winAmount').textContent = '$' + formatAmount(winner.amount);

        el.classList.add('show');

        setTimeout(() => {
          el.classList.remove('show');
        }, timeout);
      }
    }

    // ==========================================
    // WEBSOCKET
    // ==========================================
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}?role=spectator`);

      ws.onopen = () => {
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('connectionText').textContent = 'Connected';
      };

      ws.onclose = () => {
        document.getElementById('statusDot').classList.remove('connected');
        document.getElementById('connectionText').textContent = 'Disconnected';
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        document.getElementById('connectionText').textContent = 'Error';
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleEvent(msg.event, msg.data);
        } catch (e) {
          console.error('Parse error:', e);
        }
      };
    }

    // ==========================================
    // EVENT HANDLERS - Queue based for sequencing
    // ==========================================
    function handleEvent(event, data) {
      console.log('Event:', event, data);

      switch (event) {
        case 'connected':
          if (data) {
            gameState = {
              ...gameState,
              phase: data.phase || 'waiting',
              handNumber: data.handNumber || 0,
              buttonPosition: data.buttonPosition || 0,
              activePosition: data.activePosition,
              communityCards: data.communityCards || [],
              seats: data.seats || [null, null, null, null, null, null],
              pot: 0
            };
            renderState();
          }
          break;

        case 'player_sat':
          queueEvent(() => {
            gameState.seats[data.seatIndex] = {
              address: data.address,
              stack: data.stack,
              currentBet: '0',
              holeCards: null,
              isFolded: false,
              isAllIn: false
            };
            gameState.initialStacks[data.address] = data.stack;
            renderState();
          }, 300);
          break;

        case 'player_stood':
          queueEvent(() => {
            gameState.seats[data.seatIndex] = null;
            renderState();
          }, 200);
          break;

        case 'hand_started':
          queueEvent(() => {
            gameState.handNumber = data.handNumber;
            gameState.buttonPosition = data.button;
            gameState.phase = 'preflop';
            gameState.communityCards = [];
            gameState.pot = 0;
            for (const seat of gameState.seats) {
              if (seat) {
                seat.currentBet = '0';
                seat.holeCards = null;
                seat.isFolded = false;
                seat.isAllIn = false;
              }
            }
            renderState();
          }, 500);
          break;

        case 'hole_cards_dealt':
          queueEvent(() => {
            if (gameState.seats[data.seatIndex]) {
              gameState.seats[data.seatIndex].holeCards = data.cards;
              renderSeat(data.seatIndex, { animateCards: true });
            }
          }, 400);
          break;

        case 'blinds_posted':
          queueEvent(() => {
            if (data.smallBlind && gameState.seats[data.smallBlind.seat]) {
              gameState.seats[data.smallBlind.seat].currentBet = data.smallBlind.amount;
              renderSeat(data.smallBlind.seat);
              showActionBadge(data.smallBlind.seat, 'SB $' + formatAmount(data.smallBlind.amount), 1500);
            }
          }, 300);
          queueEvent(() => {
            if (data.bigBlind && gameState.seats[data.bigBlind.seat]) {
              gameState.seats[data.bigBlind.seat].currentBet = data.bigBlind.amount;
              renderSeat(data.bigBlind.seat);
              showActionBadge(data.bigBlind.seat, 'BB $' + formatAmount(data.bigBlind.amount), 1500);
            }
            document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());
            renderCenterChips();
          }, 300);
          break;

        case 'action_on':
          queueEvent(() => {
            gameState.activePosition = data.seatIndex;
            renderState();
          }, 100);
          break;

        case 'player_acted':
          queueEvent(() => {
            const seatIdx = data.seatIndex;
            let actionText = data.action.toUpperCase();

            if (data.amount && data.amount !== '0' && !['fold', 'check'].includes(data.action)) {
              actionText += ' $' + formatAmount(data.amount);
            }

            // Show action badge FIRST
            showActionBadge(seatIdx, actionText, 2500);
          }, 200);

          queueEvent(() => {
            const seatIdx = data.seatIndex;
            // Then update state
            if (gameState.seats[seatIdx]) {
              gameState.seats[seatIdx].stack = data.newStack;
              if (data.action === 'fold') {
                gameState.seats[seatIdx].isFolded = true;
                gameState.seats[seatIdx].currentBet = '0';
              } else if (['bet', 'raise', 'call'].includes(data.action)) {
                if (data.totalBet) gameState.seats[seatIdx].currentBet = data.totalBet;
              }
              if (data.action === 'all_in' || data.action === 'all-in') {
                gameState.seats[seatIdx].isAllIn = true;
              }
            }
            gameState.activePosition = null;
            renderState();
          }, 800);
          break;

        case 'flop_dealt':
          queueEvent(() => {
            gameState.phase = 'flop';
            gameState.communityCards = data.cards;
            collectBetsToPot();
            document.getElementById('phase').textContent = 'FLOP';
            document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());
            renderCommunityCards(true);
            renderCenterChips();
            for (let i = 0; i < 6; i++) renderSeat(i);
          }, 800);
          break;

        case 'turn_dealt':
          queueEvent(() => {
            gameState.phase = 'turn';
            gameState.communityCards.push(data.card);
            collectBetsToPot();
            document.getElementById('phase').textContent = 'TURN';
            document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());
            renderCommunityCards(true);
            renderCenterChips();
            for (let i = 0; i < 6; i++) renderSeat(i);
          }, 600);
          break;

        case 'river_dealt':
          queueEvent(() => {
            gameState.phase = 'river';
            gameState.communityCards.push(data.card);
            collectBetsToPot();
            document.getElementById('phase').textContent = 'RIVER';
            document.getElementById('potAmount').textContent = formatAmount(calculatePot().toString());
            renderCommunityCards(true);
            renderCenterChips();
            for (let i = 0; i < 6; i++) renderSeat(i);
          }, 600);
          break;

        case 'showdown':
          queueEvent(() => {
            gameState.phase = 'showdown';
            for (const hand of data.hands || []) {
              if (gameState.seats[hand.seatIndex]) {
                gameState.seats[hand.seatIndex].holeCards = hand.cards;
              }
            }
            document.getElementById('phase').textContent = 'SHOWDOWN';
            renderState();
          }, 500);
          break;

        case 'pot_awarded':
          queueEvent(() => {
            collectBetsToPot();
            let winHandName = '';
            for (const winner of data.winners || []) {
              winHandName = winner.handName || '';
            }
            showWinner(data.winners, winHandName);
          }, 500);
          break;

        case 'hand_complete':
          queueEvent(() => {
            gameState.phase = 'waiting';
            gameState.activePosition = null;
            gameState.pot = 0;
            renderState();
          }, 2000);
          break;

        case 'phase_changed':
          queueEvent(() => {
            gameState.phase = data.phase;
            renderState();
          }, 100);
          break;

        case 'chat':
          queueEvent(() => {
            const chatSeatIndex = gameState.seats.findIndex(s => s && s.address === data.address);
            if (chatSeatIndex !== -1) {
              showChatBubble(chatSeatIndex, data.message, 3500);
            }
          }, 100);
          break;
      }
    }

    // ==========================================
    // DEMO CONTROLS
    // ==========================================
    async function startDemo() {
      const btn = document.getElementById('demoBtn');
      const speed = document.getElementById('speedSelect').value;
      btn.disabled = true;
      btn.textContent = 'STARTING...';

      try {
        const response = await fetch('/api/operator/demo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numAgents: 4, hands: 3, speed })
        });
        if (!response.ok) throw new Error('Failed');
      } catch (e) {
        console.error('Demo failed:', e);
      } finally {
        btn.disabled = false;
        btn.textContent = 'START DEMO';
      }
    }

    async function startLLMDemo() {
      const btn = document.getElementById('llmDemoBtn');
      btn.disabled = true;
      btn.textContent = 'AI THINKING...';

      try {
        const response = await fetch('/api/operator/demo-llm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numAgents: 4, hands: 2 })
        });
        if (!response.ok) throw new Error('Failed');
      } catch (e) {
        console.error('LLM Demo failed:', e);
      } finally {
        btn.disabled = false;
        btn.textContent = 'AI DEMO';
      }
    }

    // ==========================================
    // INIT
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
      renderState();
      connectWebSocket();
    });
  </script>
</body>
</html>
